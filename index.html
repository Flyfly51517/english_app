<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<title>Mimi English</title>

<link rel="apple-touch-icon" href="icon.png">
<link rel="icon" href="icon.png" type="image/png">

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Varela+Round&display=swap" rel="stylesheet">

<style>
    /* --- åŸºç¤è¨­å®š --- */
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    
    :root { 
        --bg-body: #F3F4F6;
        --bg-card: #FFFFFF;
        --btn-purple: linear-gradient(90deg, #a18cd1 0%, #fbc2eb 100%);
        --btn-shadow: 0 4px 15px rgba(161, 140, 209, 0.4);
        --btn-orange: linear-gradient(90deg, #ff9a9e 0%, #fecfef 100%);
        --btn-grey: #dfe6e9;
        --text-main: #2d3436;
        --text-sub: #636e72;
        --radius-card: 24px;
        --radius-btn: 50px;
    }
    
    body { 
        font-family: "Varela Round", "Miku", "å¾®è»Ÿæ­£é»‘é«”", sans-serif;
        background: var(--bg-body);
        min-height: 100vh;
        margin: 0; 
        padding: 20px 15px calc(20px + env(safe-area-inset-bottom));
        color: var(--text-main);
        line-height: 1.5;
    }

    .container { 
        max-width: 600px; 
        margin: 0 auto; 
        background: var(--bg-card); 
        padding: 25px; 
        border-radius: var(--radius-card); 
        box-shadow: 0 10px 30px rgba(0,0,0,0.08); 
        position: relative;
        overflow: hidden;
        min-height: 650px;
        display: flex;
        flex-direction: column;
    }

    /* --- ç•«é¢åˆ‡æ› --- */
    .app-view { display: none; width: 100%; flex: 1; animation: fadeIn 0.4s ease-out; }
    .app-view.active { display: flex; flex-direction: column; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    /* --- é¦–é  --- */
    .header-center { text-align: center; margin-bottom: 30px; margin-top: 40px; }
    .app-logo { 
        width: 110px; height: 110px; border-radius: 28px; 
        box-shadow: 0 8px 20px rgba(0,0,0,0.1); margin-bottom: 15px; 
        background: #fff; object-fit: cover;
    }
    h1 { color: #8e44ad; margin: 0; font-size: 1.8rem; font-weight: 800; letter-spacing: -0.5px; }
    p.subtitle { color: var(--text-sub); font-size: 1.1rem; margin-top: 5px; font-weight: bold; }

    /* é€£çºŒç·´ç¿’å¾½ç«  */
    .streak-badge {
        background: #fff3e0; color: #e67e22;
        display: inline-flex; align-items: center; justify-content: center;
        padding: 8px 16px; border-radius: 20px;
        font-weight: 800; font-size: 1rem;
        margin-bottom: 20px;
        box-shadow: 0 2px 5px rgba(230, 126, 34, 0.2);
    }

    .unit-selector-container { margin-bottom: 10px; width: 100%; }
    .unit-select {
        width: 100%; padding: 15px;
        font-size: 1.1rem; font-weight: bold; color: #555;
        border: 2px solid #e1bee7; border-radius: 15px;
        background: #fff; outline: none; appearance: none;
        background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23a18cd1' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
        background-repeat: no-repeat; background-position: right 15px center; background-size: 20px;
    }

    /* --- æŒ‰éˆ•ç³»çµ± --- */
    .btn-stack {
        margin-top: 30px; 
        display: flex; flex-direction: column; gap: 15px;
        width: 100%; padding-bottom: 40px;
    }

    .btn {
        display: flex; justify-content: center; align-items: center;
        width: 100%; height: 60px; border-radius: var(--radius-btn);
        border: none; font-size: 1.2rem; font-weight: bold; 
        color: white; cursor: pointer; transition: transform 0.1s;
        text-decoration: none; position: relative; overflow: hidden;
        font-family: "Varela Round", sans-serif;
    }
    .btn:active { transform: scale(0.97); }
    
    .btn-purple { background: var(--btn-purple); box-shadow: var(--btn-shadow); }
    .btn-grey { background: var(--btn-grey); color: #636e72; box-shadow: none; }
    .btn-line { background: linear-gradient(90deg, #06C755 0%, #28d26f 100%); box-shadow: 0 4px 15px rgba(6, 199, 85, 0.3); }
    .btn-retry-mistakes { background: var(--btn-orange); color: #d63031; box-shadow: 0 4px 15px rgba(255, 154, 158, 0.4); }

    /* --- æ¸¬é©—å€ --- */
    .quiz-info { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
    .page-indicator { font-weight: bold; color: #a18cd1; font-size: 1.1rem; }
    
    .progress-track { background-color: #f0f0f0; border-radius: 10px; height: 8px; margin-bottom: 25px; overflow: hidden; width: 100%; }
    .progress-fill { background: var(--btn-purple); height: 100%; width: 0%; transition: width 0.3s ease; }

    .quiz-page { display: none; width: 100%; }
    .quiz-page.active { display: block; animation: slideIn 0.3s ease-out; }
    @keyframes slideIn { from { opacity: 0; transform: translateX(20px); } to { opacity: 1; transform: translateX(0); } }

    .question-card { 
        background: #fff; border: 2px solid #f3e5f5; border-radius: 20px; 
        padding: 25px 20px; margin-bottom: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.02);
    }
    
    /* æ¨™ç±¤èˆ‡é¡Œè™Ÿ */
    .q-text { 
        font-size: 1.3rem; font-weight: 800; color: #444; 
        margin-bottom: 15px; line-height: 1.5; display: flex; align-items: center; flex-wrap: wrap;
    }
    .q-num { color: #a18cd1; margin-right: 8px; }
    
    .chip {
        display: inline-block; padding: 4px 12px; border-radius: 20px;
        font-size: 0.85rem; font-weight: bold; color: white; margin-right: 8px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .chip-spell { background: #74b9ff; } 
    .chip-choice { background: #ff7675; }

    .q-sub { font-size: 1rem; color: #888; font-weight: normal; margin-bottom: 20px; line-height: 1.5; }

    /* é—œéµï¼šå…‹æ¼å­—æŒ–ç©ºæ¨£å¼ (è®“åº•ç·šæ›´æ˜é¡¯) */
    .sentence-display {
        font-size: 1.3rem; font-weight: 500; color: #2d3436; 
        line-height: 1.8; margin-bottom: 15px;
    }
    /* æç¤ºå­— (p_____) çš„æ¨£å¼ */
    .cloze-hint {
        color: #8e44ad; font-weight: 800; 
        border-bottom: 2px solid #8e44ad; 
        padding: 0 4px; letter-spacing: 1px;
    }

    /* è¼¸å…¥æ¡† */
    .input-box {
        width: 100%; padding: 14px; font-size: 1.2rem;
        border: 2px solid #e1bee7; border-radius: 15px;
        color: #555; background: #fff; outline: none; 
        font-family: "Varela Round", monospace;
    }
    .input-box:focus { border-color: #8e44ad; box-shadow: 0 0 0 3px rgba(142, 68, 173, 0.1); }

    /* é¸é …æŒ‰éˆ• */
    .option-btn {
        display: flex; align-items: center; padding: 16px 15px; margin-bottom: 10px;
        border: 2px solid transparent; border-radius: 15px;
        background: #f8f9fa; cursor: pointer; width: 100%; transition: 0.2s;
    }
    .option-btn:hover { background: #f3e5f5; border-color: #e1bee7; }
    .option-btn input { margin-right: 15px; transform: scale(1.3); accent-color: #8e44ad; }
    .option-txt { font-size: 1.1rem; color: #555; font-weight: bold; }

    /* --- æˆç¸¾å€ --- */
    .score-circle {
        width: auto; height: auto; 
        background: transparent; border: none; box-shadow: none;
        display: flex; justify-content: center; align-items: center;
        margin: 60px auto 40px auto; 
    }
    .score-val { font-size: 7rem; font-weight: 900; color: #8e44ad; line-height: 1; font-family: "Varela Round", sans-serif; }

    /* é›£åº¦æ¨™ç±¤ */
    .diff-badge { 
        display: inline-flex; align-items: center; justify-content: center;
        padding: 8px 20px; border-radius: 30px; font-size: 1rem; font-weight: bold;
        color: white; margin-bottom: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
    .d-easy { background: #55efc4; } .d-norm { background: #fdcb6e; } .d-hard { background: #ff7675; }

    .mistake-container {
        border: 2px dashed #ffcccc; border-radius: 20px; background: #fff5f7;
        overflow: hidden; margin-bottom: 10px; display: none; text-align: left; padding: 15px; width: 100%;
    }
    .mistake-list { max-height: 180px; overflow-y: auto; padding: 0; margin: 0; list-style: none; }
    .mistake-li { padding: 8px 0; border-bottom: 1px dashed #ffdbdb; font-size: 0.9rem; }
    .m-word { font-weight: 700; color: #555; }
    .m-wrong { color: #d63031; text-decoration: line-through; margin-right: 5px; }
    .m-correct { color: #00b894; font-weight: 700; }

    /* --- æ­·å²ç´€éŒ„ --- */
    .history-list { max-height: 450px; overflow-y: auto; width: 100%; }
    .history-card {
        background: #fff; border: 2px solid #f0f0f0; border-radius: 20px; padding: 15px; margin-bottom: 12px;
    }
    .h-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
    .h-date { font-size: 0.85rem; color: #aaa; font-weight: bold; }
    .h-score { font-size: 1.4rem; font-weight: 900; color: #8e44ad; }
    
    .empty-state { text-align: center; color: #bbb; padding: 40px 0; font-weight: bold; }
    .btn i-icon { margin-right: 8px; font-style: normal; }

</style>
</head>
<body>

<div class="container">
    
    <div id="menu-screen" class="app-view active">
        <div class="header-center">
            <img src="icon.png" class="app-logo" alt="Logo" onerror="this.src='https://via.placeholder.com/120?text=App'">
            <h1>Mimi English</h1>
            <p class="subtitle">Unit 5 & 6</p>
        </div>
        
        <div style="text-align:center;">
            <div id="streak-display" class="streak-badge">ğŸ”¥ é€£çºŒç·´ç¿’ 0 å¤©</div>
        </div>

        <div class="unit-selector-container">
            <select id="unit-selector" class="unit-select">
                <option value="56">Unit 5 & 6</option>
                <option value="78">Unit 7 & 8 (New!)</option>
                <option value="all">å…¨éƒ¨è¤‡ç¿’ (All)</option>
            </select>
        </div>
        
        <div class="btn-stack">
            <button class="btn btn-purple" onclick="startNewQuiz()"><i-icon>ğŸš€</i-icon> æ¯æ—¥æ¸¬é©—</button>
            <button class="btn btn-purple" onclick="showHistory()"><i-icon>ğŸ“œ</i-icon> æ­·å²ç´€éŒ„</button>
        </div>
    </div>

    <div id="quiz-screen" class="app-view">
        <div class="quiz-info">
            <div style="font-weight:bold; color:#444;">æ¸¬é©—é€²è¡Œä¸­</div>
            <div class="page-indicator" id="pageIndicator">1 / 6</div>
        </div>

        <div class="progress-track">
            <div class="progress-fill" id="progressBar"></div>
        </div>

        <form id="quizForm" autocomplete="off" style="flex:1; overflow-y:auto; padding-bottom: 20px;">
            <div id="quiz-pages"></div>
        </form>
        
        <div class="btn-stack">
            <button type="button" class="btn btn-purple" id="btnNext" onclick="nextPage()">ä¸‹ä¸€é  â¡</button>
            <button type="button" class="btn btn-purple" id="btnSubmit" onclick="submitQuiz()" style="display:none;">äº¤å· âœ¨</button>
            <button class="btn btn-grey" onclick="goHome()">ğŸ  æš«åœä¸¦å›é¦–é </button>
        </div>
    </div>

    <div id="score-screen" class="app-view">
        <div class="header-center" style="margin-top:0;">
            <h1 style="font-size:1.5rem;">æ¸¬é©—æˆç¸¾</h1>
        </div>
        
        <div class="score-circle">
            <div class="score-val" id="score-text">0</div>
        </div>
        
        <div style="text-align:center; margin-bottom:10px; margin-top: 10px;">
            <div id="score-difficulty" class="diff-badge d-norm">é›£åº¦ï¼šé©ä¸­</div>
            <p id="comment" style="color:#555; font-weight:bold; font-size: 1.1rem; margin-top:15px;"></p>
        </div>

        <div class="mistake-container" id="mistake-area">
            <div style="font-weight:bold; color:#d63031; margin-bottom:10px; text-align:center;">ğŸŠ éŒ¯é¡Œæª¢è¨</div>
            <ul class="mistake-list" id="mistake-list"></ul>
        </div>
        
        <div class="btn-stack" style="padding-top:0;">
            <button id="btn-retry-mistakes" class="btn btn-retry-mistakes" style="display:none;" onclick="startRetryQuiz()">
                <i-icon>ğŸ’ª</i-icon> åªè€ƒéŒ¯é¡Œ (è¨‚æ­£)
            </button>

            <a id="line-share-btn" class="btn btn-line" target="_blank">
                <i-icon>ğŸ“</i-icon> åˆ†äº«æˆç¸¾ (Line)
            </a>
            
            <a id="wrong-share-btn" class="btn" style="background:#ff9f43; display:none;" target="_blank">
                <i-icon>ğŸŠ</i-icon> åŒ¯å‡ºéŒ¯é¡Œ (Line)
            </a>

            <button class="btn btn-purple" onclick="startNewQuiz()"><i-icon>ğŸ”„</i-icon> å…¨éƒ¨é‡è€ƒ</button>
            <button class="btn btn-grey" onclick="goHome()"><i-icon>ğŸ </i-icon> å›ä¸»é¸å–®</button>
        </div>
    </div>

    <div id="history-screen" class="app-view">
        <div class="quiz-info">
            <div style="font-weight:bold; font-size:1.2rem;">ğŸ“œ æ­·å²ç´€éŒ„</div>
            <button class="btn btn-grey" onclick="goHome()" style="width:auto; height:40px; font-size:0.9rem; padding:0 15px;">é—œé–‰</button>
        </div>
        
        <div class="history-list" id="history-list-container"></div>
    </div>

</div>

<script>
    /* ----------------------------------------------------
       DATA SETS - é¡Œåº«
    ---------------------------------------------------- */
    
    // Unit 5 & 6 (ç¾æœ‰è³‡æ–™)
    const data_unit56 = [
        { w: "public", c: "å…¬çœ¾(çš„)", s: "The library is a ______ building, so anyone can go inside to read." },
        { w: "play", c: "æ‰®æ¼”", s: "In the school drama, he was chosen to ______ the role of the ancient king." },
        { w: "uniform", c: "åˆ¶æœ", s: "All the players wore the same red and white ______ to show they were on the same team." },
        { w: "bottom", c: "è‡€éƒ¨ï¼›åº•éƒ¨", s: "Please sign your name at the very ______ of the document." },
        { w: "tail", c: "å°¾å·´", s: "The happy dog wagged its ______ when its owner came home." },
        { w: "pin", c: "é£¾é‡ï¼›èƒ¸é‡", s: "She attached the name tag to her shirt with a small safety ______." },
        { w: "bow", c: "è´è¶çµ", s: "She tied a beautiful red ______ around the birthday gift." },
        { w: "dot", c: "åœ“é»", s: "The end of a sentence is marked by a small ______." },
        { w: "round", c: "åœ“å½¢çš„", s: "The moon looks completely ______ when it is full." },
        { w: "square", c: "æ­£æ–¹å½¢(çš„)", s: "A ______ has four equal sides and four corners." },
        { w: "string", c: "ä¸²ï¼›ç·š", s: "I need a piece of ______ to tie this package together." },
        { w: "line", c: "éšŠä¼ï¼›ç›´ç·š", s: "The students stood in a straight ______ waiting for the bus." },
        { w: "arrive", c: "æŠµé”", s: "We expect the train to ______ at the station at 5:00 PM." },
        { w: "appear", c: "å‡ºç¾", s: "As the clouds moved away, the sun began to ______." },
        { w: "notice", c: "æ³¨æ„åˆ°", s: "Did you ______ that he got a new haircut today?" },
        { w: "lead", c: "é€šå¾€", s: "This path will ______ you directly to the river." },
        { w: "restroom", c: "æ´—æ‰‹é–“", s: "Excuse me, could you tell me where the ______ is?" },
        { w: "bath", c: "æ²æµ´", s: "After a long day, she likes to take a warm ______ to relax." },
        { w: "neighbor", c: "é„°å±…", s: "Our ______ is very kind and often helps us watch our dog." },
        { w: "foreigner", c: "å¤–åœ‹äºº", s: "Since he didn't speak the local language, they knew he was a ______." },
        { w: "business", c: "ç”Ÿæ„", s: "My uncle travels to Japan often to do ______ with a large company." },
        { w: "businessman", c: "å•†äºº", s: "The wealthy ______ owns several shops in the city." },
        { w: "workbook", c: "ä½œæ¥­æœ¬", s: "Please complete page 10 in your English ______ for homework." },
        { w: "exercise", c: "ç·´ç¿’", s: "You should ______ regularly to keep your body healthy and strong." },
        { w: "hobby", c: "å—œå¥½", s: "Collecting stamps is a popular ______ for many people." },
        { w: "born", c: "å‡ºç”Ÿçš„", s: "She was ______ in a small town but moved to the city later." },
        { w: "light", c: "è¼•çš„", s: "This feather is very ______; the wind can blow it away easily." },
        { w: "prize", c: "ç", s: "He won the first ______ in the science competition." },
        { w: "main", c: "ä¸»è¦çš„", s: "The ______ reason for his visit was to see his family." },
        { w: "topic", c: "ä¸»é¡Œ", s: "The ______ of today's meeting is how to save energy." },
        { w: "belong", c: "å±¬æ–¼", s: "Does this blue jacket ______ to you or your brother?" },
        { w: "key", c: "é—œéµ(çš„)", s: "Patience is the ______ to solving this difficult puzzle." },
        { w: "knowledge", c: "çŸ¥è­˜", s: "Reading books is the best way to gain new ______ about the world." },
        { w: "dictionary", c: "å­—å…¸", s: "If you don't know the meaning of this word, look it up in a ______." },
        { w: "planet", c: "è¡Œæ˜Ÿ", s: "Jupiter is the largest ______ in our solar system." },
        { w: "go on", c: "ç™¼ç”Ÿ", s: "I heard a loud noise and wondered what was ______ing ______ outside." },
        { w: "be no stranger to", c: "å°...ä¸é™Œç”Ÿ", s: "As a chef, he ______ hard work in the kitchen." },
        { w: "town", c: "åŸé®", s: "We live in a quiet ______ where everyone knows each other." },
        { w: "visitor", c: "éŠå®¢", s: "The museum welcomes every ______ with a free map." },
        { w: "invite", c: "é‚€è«‹", s: "I want to ______ all my friends to my birthday party." },
        { w: "apartment", c: "å…¬å¯“", s: "They live in a small ______ on the fifth floor." },
        { w: "sidewalk", c: "äººè¡Œé“", s: "Pedestrians must walk on the ______ to stay safe from cars." },
        { w: "side", c: "é‚Šï¼›é¢", s: "Please write your name on the other ______ of the paper." },
        { w: "blind", c: "ç›²çš„", s: "The guide dog helps the ______ man cross the street safely." },
        { w: "seat", c: "åº§ä½", s: "The bus was full, so I gave my ______ to an elderly lady." },
        { w: "beside", c: "åœ¨...æ—é‚Š", s: "Come and sit ______ me so we can talk." },
        { w: "except", c: "é™¤äº†", s: "Everyone passed the test ______ for John, who was sick." },
        { w: "perhaps", c: "æˆ–è¨±", s: "______ it will rain later, so you should take an umbrella." },
        { w: "joke", c: "ç©ç¬‘", s: "He told a funny ______ that made everyone laugh." },
        { w: "April Fools' Day", c: "æ„šäººç¯€", s: "On ______, people often play tricks and jokes on each other." },
        { w: "present", c: "ç¦®ç‰©", s: "She gave him a watch as a birthday ______." },
        { w: "kiss", c: "å»", s: "The mother gave her baby a gentle ______ on the forehead." },
        { w: "serious", c: "èªçœŸçš„", s: "You need to be ______ about your studies if you want to pass." },
        { w: "lazy", c: "æ‡¶æƒ°çš„", s: "Don't be ______; get up and help with the housework." },
        { w: "rich", c: "å¯Œæœ‰çš„", s: "The ______ man donated a lot of money to charity." },
        { w: "glad", c: "é«˜èˆˆçš„", s: "I am very ______ to meet you finally." },
        { w: "polite", c: "æœ‰ç¦®è²Œçš„", s: "It is ______ to say 'please' and 'thank you' when asking for help." },
        { w: "blank", c: "ç©ºç™½(çš„)", s: "Fill in the ______ space with your name." },
        { w: "paper", c: "ç´™", s: "She wrote a letter on a piece of white ______." },
        { w: "tape", c: "è† å¸¶", s: "Use some ______ to fix the torn page of the book." },
        { w: "rise", c: "å‡èµ·", s: "We woke up early to watch the sun ______ over the mountains." },
        { w: "smoke", c: "ç…™", s: "Where there is ______, there is usually fire." },
        { w: "heat", c: "ç†±", s: "I can't stand the summer ______; I need air conditioning." },
        { w: "cover", c: "è¦†è“‹", s: "Please ______ your mouth when you cough to stop germs." },
        { w: "mud", c: "æ³¥åœŸ", s: "After the rain, the field was full of sticky ______." },
        { w: "spell", c: "å’’èª", s: "In the story, the witch cast a magic ______ on the prince." },
        { w: "lie", c: "èºº", s: "I'm tired, so I'm going to ______ down on the sofa." },
        { w: "ahead", c: "åœ¨å‰æ–¹", s: "Look ______! There is a car stopping in front of us." },
        { w: "somewhere", c: "æŸè™•", s: "I lost my keys ______ in the house, but I can't find them." },
        { w: "draw", c: "ææ¬¾", s: "He went to the bank to ______ some cash for the weekend." },
        { w: "used to", c: "éå»æ™‚å¸¸", s: "I ______ play soccer every day, but now I'm too busy." },
        { w: "have bigger fish to fry", c: "æœ‰æ›´é‡è¦çš„äº‹", s: "I can't worry about this small problem; I ______." }
    ];

    // Unit 7 & 8 (ç¯„ä¾‹è³‡æ–™)
    const data_unit78 = [
        { w: "example", c: "ç¯„ä¾‹", s: "This is just an ______." },
        { w: "future", c: "æœªä¾†", s: "In the ______, cars might fly." },
        { w: "dream", c: "å¤¢æƒ³", s: "My ______ is to become a doctor." }
    ];

    /* --- å…¨åŸŸè®Šæ•¸ --- */
    const TOTAL_QUESTIONS = 55;
    const QUESTIONS_PER_PAGE = 10; 
    let currentQuizData = [];
    let currentPage = 1;
    let totalPages = 1;
    let currentSpellingCount = 0;
    let startTime = null;
    let retryPool = []; 

    /* --- 1. æ¯æ—¥æŒ‘æˆ°é‚è¼¯ --- */
    function checkStreak() {
        let lastDate = localStorage.getItem('mimi_last_date');
        let streak = parseInt(localStorage.getItem('mimi_streak') || 0);
        document.getElementById('streak-display').innerText = `ğŸ”¥ é€£çºŒç·´ç¿’ ${streak} å¤©`;
    }

    function updateStreak() {
        let today = new Date().toDateString();
        let lastDate = localStorage.getItem('mimi_last_date');
        let streak = parseInt(localStorage.getItem('mimi_streak') || 0);

        if (lastDate !== today) {
            let yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            if (lastDate === yesterday.toDateString()) {
                streak++;
            } else {
                streak = 1;
            }
            localStorage.setItem('mimi_last_date', today);
            localStorage.setItem('mimi_streak', streak);
        }
    }
    checkStreak();

    /* --- 2. ç•«é¢åˆ‡æ› --- */
    function showScreen(screenId) {
        document.querySelectorAll('.app-view').forEach(s => s.classList.remove('active'));
        document.getElementById(screenId).classList.add('active');
        window.scrollTo(0,0);
        if(screenId === 'menu-screen') checkStreak();
    }
    function goHome() { showScreen('menu-screen'); }

    /* --- 3. æ¸¬é©—æ ¸å¿ƒé‚è¼¯ --- */
    function shuffle(array) {
        let currentIndex = array.length, randomIndex;
        while (currentIndex != 0) {
            randomIndex = Math.floor(Math.random() * currentIndex);
            currentIndex--;
            [array[currentIndex], array[randomIndex]] = [array[randomIndex], array[currentIndex]];
        }
        return array;
    }

    function startNewQuiz() {
        let selection = document.getElementById('unit-selector').value;
        let sourceData = [];
        if (selection === '56') sourceData = [...data_unit56];
        else if (selection === '78') sourceData = [...data_unit78];
        else sourceData = [...data_unit56, ...data_unit78];

        generateQuiz(shuffle(sourceData));
    }

    function startRetryQuiz() {
        if(retryPool.length === 0) return;
        generateQuiz(shuffle([...retryPool]));
    }

    function generateQuiz(sourceArray) {
        startTime = new Date(); 
        retryPool = [];
        let quizPool = sourceArray.length > TOTAL_QUESTIONS ? sourceArray.slice(0, TOTAL_QUESTIONS) : sourceArray;
        currentSpellingCount = 0;

        currentQuizData = quizPool.map((item, index) => {
            let rand = Math.random();
            let type;
            // 60% æ‹¼å­—(å…‹æ¼å­—)ï¼Œ40% é¸æ“‡
            if (rand < 0.6) {
                type = 0; 
                currentSpellingCount++;
            } else {
                type = Math.random() < 0.5 ? 1 : 2;
            }
            
            let qNum = index + 1;

            let qObj = {
                id: index + 1,
                type: type,
                correct: item.w,
                correctDisplay: item.w,
                options: [],
                qTitle: "", 
                qContent: "",
                wordPair: `${item.w} = ${item.c}`,
                rawItem: item
            };

            let distractors = [];
            let fullPool = [...data_unit56, ...data_unit78];
            while(distractors.length < 3) {
                let r = fullPool[Math.floor(Math.random() * fullPool.length)];
                if (r && r.w !== item.w && !distractors.includes(r)) distractors.push(r);
            }

            if (type === 0) { // Spelling (Cloze Mode)
                // 1. ç”¢ç”Ÿæç¤ºå­—ï¼šé¦–å­— + åº•ç·š
                let firstLetter = item.w.charAt(0);
                let restLength = Math.max(0, item.w.length - 1);
                let hintMask = firstLetter + "_".repeat(restLength); // p_____

                // 2. *** é—œéµä¿®æ­£ï¼šæ™ºæ…§å¡«å…¥æç¤ºå­— ***
                let sentence = item.s;
                
                // å¦‚æœå¥å­æœ¬ä¾†å°±æœ‰åº•ç·š (______), æŠŠåº•ç·šæ›æˆ hintMask
                if (sentence.includes("______")) {
                    sentence = sentence.replace(/______/g, `<span class='cloze-hint'>${hintMask}</span>`);
                } 
                // å¦‚æœå¥å­æ˜¯å®Œæ•´çš„å–®å­—ï¼Œå‰‡æŠŠå–®å­—æ›æˆ hintMask (ä¸åˆ†å¤§å°å¯«)
                else {
                    sentence = sentence.replace(new RegExp(item.w, "ig"), `<span class='cloze-hint'>${hintMask}</span>`);
                }

                qObj.qTitle = `<span class="q-num">Q${qNum}.</span> <span class="chip chip-spell">æ‹¼å­—</span>`;
                // åªé¡¯ç¤ºè‹±æ–‡å¥å­
                qObj.qContent = `<div class="sentence-display">${sentence}</div>`;
            } else if (type === 1) { // Choice C->E
                qObj.qTitle = `<span class="q-num">Q${qNum}.</span> <span class="chip chip-choice">é¸æ“‡</span>`;
                qObj.qContent = `<div style="font-size:1.2rem; font-weight:bold;">${item.c}</div><div style="font-size:0.9rem; color:#888; margin-top:5px;">è«‹é¸å‡ºæ­£ç¢ºçš„è‹±æ–‡å–®å­—</div>`;
                qObj.options = shuffle([item.w, ...distractors.map(d => d.w)]);
            } else { // Choice E->C
                qObj.qTitle = `<span class="q-num">Q${qNum}.</span> <span class="chip chip-choice">é¸æ“‡</span>`;
                qObj.qContent = `<div style="font-size:1.2rem; font-weight:bold;">${item.w}</div><div style="font-size:0.9rem; color:#888; margin-top:5px;">è«‹é¸å‡ºä¸­æ–‡æ„æ€</div>`;
                qObj.correctDisplay = item.c;
                qObj.options = shuffle([item.c, ...distractors.map(d => d.c)]);
            }
            return qObj;
        });

        currentPage = 1;
        totalPages = Math.ceil(currentQuizData.length / QUESTIONS_PER_PAGE);
        renderPages();
        updateUI();
        showScreen('quiz-screen');
    }

    function renderPages() {
        const container = document.getElementById('quiz-pages');
        let html = "";
        for (let p = 1; p <= totalPages; p++) {
            let active = (p === 1) ? "active" : "";
            html += `<div class="quiz-page ${active}" id="page-${p}">`;
            let start = (p - 1) * QUESTIONS_PER_PAGE;
            let end = Math.min(start + QUESTIONS_PER_PAGE, currentQuizData.length);
            
            for (let i = start; i < end; i++) {
                let q = currentQuizData[i];
                let inputHtml = "";
                
                if (q.type === 0) {
                    inputHtml = `<input type="text" class="input-box" id="input-${q.id}" placeholder="è«‹è¼¸å…¥å–®å­—..." autocomplete="off" spellcheck="false">`;
                } else {
                    q.options.forEach(opt => {
                        inputHtml += `
                        <label class="option-btn">
                            <input type="radio" name="q${q.id}" value="${opt}">
                            <span class="option-txt">${opt}</span>
                        </label>`;
                    });
                }

                html += `
                <div class="question-card">
                    <div class="q-text" style="display:flex; justify-content:space-between; align-items:center;">
                        <div>${q.qTitle}</div>
                    </div>
                    <div class="q-sub" style="margin-top:10px;">${q.qContent}</div>
                    <div>${inputHtml}</div>
                </div>`;
            }
            html += `</div>`;
        }
        container.innerHTML = html;
    }

    function nextPage() {
        document.getElementById(`page-${currentPage}`).classList.remove('active');
        currentPage++;
        document.getElementById(`page-${currentPage}`).classList.add('active');
        window.scrollTo(0, 0);
        updateUI();
    }

    function updateUI() {
        let pct = (currentPage / totalPages) * 100;
        document.getElementById('progressBar').style.width = `${pct}%`;
        document.getElementById('pageIndicator').innerText = `${currentPage} / ${totalPages}`;

        const btnNext = document.getElementById('btnNext');
        const btnSubmit = document.getElementById('btnSubmit');

        if (currentPage === totalPages) {
            btnNext.style.display = 'none';
            btnSubmit.style.display = 'flex';
        } else {
            btnNext.style.display = 'flex';
            btnSubmit.style.display = 'none';
        }
    }

    function submitQuiz() {
        const endTime = new Date();
        const durationSec = Math.floor((endTime - startTime) / 1000);
        const mm = Math.floor(durationSec / 60);
        const ss = durationSec % 60;
        const timeStr = `${mm}min ${ss}s`;

        let correctCount = 0;
        let wrongItems = [];
        let mistakeHtml = "";

        currentQuizData.forEach(q => {
            let isCorrect = false;
            let userVal = "";
            let correctVal = "";

            if (q.type === 0) {
                let el = document.getElementById(`input-${q.id}`);
                userVal = el ? el.value.trim() : "";
                correctVal = q.correct;
                if (userVal.toLowerCase() === correctVal.toLowerCase()) isCorrect = true;
            } else {
                let el = document.querySelector(`input[name="q${q.id}"]:checked`);
                userVal = el ? el.value : "(æœªé¸)";
                correctVal = q.type === 1 ? q.correct : q.correctDisplay;
                if (userVal === correctVal) isCorrect = true;
            }

            if (isCorrect) {
                correctCount++;
            } else {
                if(q.rawItem) retryPool.push(q.rawItem);
                wrongItems.push({ q: q.wordPair, user: userVal, right: correctVal });
                mistakeHtml += `
                <li class="mistake-li">
                    <div class="m-word">${q.wordPair}</div>
                    <div class="m-ans">
                        <span class="m-wrong">${userVal}</span> 
                        <span class="m-correct">${correctVal}</span>
                    </div>
                </li>`;
            }
        });

        let finalScore = Math.round((correctCount / currentQuizData.length) * 100);
        const today = new Date();
        const dateStr = `${today.getFullYear()}/${today.getMonth()+1}/${today.getDate()}`;

        // é›£åº¦è¨ˆç®—
        let diffLabel = "é›£åº¦ï¼šé©ä¸­";
        let diffClass = "d-norm";
        let spellPct = (currentSpellingCount / currentQuizData.length) * 100;
        if (spellPct > 45) { diffLabel = "é›£åº¦ï¼šå›°é›£"; diffClass = "d-hard"; }
        else if (spellPct < 25) { diffLabel = "é›£åº¦ï¼šç°¡å–®"; diffClass = "d-easy"; }

        document.getElementById('score-text').innerText = finalScore;
        const diffEl = document.getElementById('score-difficulty');
        diffEl.className = `diff-badge ${diffClass}`;
        diffEl.innerText = diffLabel;

        document.getElementById('comment').innerText = `ç­”å°ï¼š${correctCount} / ${currentQuizData.length} é¡Œ`;
        
        const mistakeArea = document.getElementById('mistake-area');
        const wrongBtn = document.getElementById('wrong-share-btn');
        const retryBtn = document.getElementById('btn-retry-mistakes');
        
        if (wrongItems.length > 0) {
            mistakeArea.style.display = 'block';
            wrongBtn.style.display = 'flex';
            retryBtn.style.display = 'flex'; 
            retryBtn.innerHTML = `<i-icon>ğŸ’ª</i-icon> åªè€ƒéŒ¯é¡Œ (${wrongItems.length}é¡Œ)`;
            
            document.getElementById('mistake-list').innerHTML = mistakeHtml;
            
            let wrongTextList = `ã€éŒ¯é¡Œæ¸…å–®ã€‘(${dateStr})\nè«‹æŠ„å¯«è¨‚æ­£ï¼š\n`;
            wrongItems.forEach((item, index) => {
                wrongTextList += `${index + 1}. ${item.q}\n`;
            });
            wrongBtn.href = `https://line.me/R/msg/text/?${encodeURIComponent(wrongTextList)}`;

        } else {
            mistakeArea.style.display = 'none';
            wrongBtn.style.display = 'none';
            retryBtn.style.display = 'none';
            document.getElementById('comment').innerText += " (å¤ªæ£’äº†ï¼å…¨å°ï¼)";
        }
        
        const shareTextScore = `ã€Unit 5&6 æˆç¸¾å›å ±ã€‘\næ—¥æœŸï¼š${dateStr}\næ¸¬é©—æ™‚é–“ï¼š${timeStr}\né›£åº¦ï¼š${diffLabel}\nå¾—åˆ†ï¼š${finalScore} åˆ†\nç­”å°ï¼š${correctCount} / ${currentQuizData.length}\nè€å¸«ï¼Œé€™æ˜¯æˆ‘ä»Šå¤©çš„ç·´ç¿’æˆç¸¾ï¼`;
        document.getElementById('line-share-btn').href = `https://line.me/R/msg/text/?${encodeURIComponent(shareTextScore)}`;

        saveHistory(dateStr, finalScore, wrongItems, diffLabel, diffClass);
        updateStreak();
        showScreen('score-screen');
    }

    function saveHistory(date, score, wrongList, diffLabel, diffClass) {
        let history = JSON.parse(localStorage.getItem('mimi_history_final_v5') || '[]');
        let newRecord = { date, score, wrongs: wrongList, diffLabel, diffClass };
        history.unshift(newRecord);
        if(history.length > 50) history.pop();
        localStorage.setItem('mimi_history_final_v5', JSON.stringify(history));
    }

    function showHistory() {
        let history = JSON.parse(localStorage.getItem('mimi_history_final_v5') || '[]');
        let container = document.getElementById('history-list-container');
        
        if (history.length === 0) {
            container.innerHTML = '<div class="empty-state">å°šç„¡æ¸¬é©—ç´€éŒ„<br>Go Start!</div>';
        } else {
            let html = "";
            history.forEach((rec) => {
                let dLabel = rec.diffLabel || "é›£åº¦ï¼šé©ä¸­";
                let dClass = rec.diffClass || "d-norm"; 

                let wrongsHtml = "";
                if (rec.wrongs && rec.wrongs.length > 0) {
                    wrongsHtml = `<details><summary>æŸ¥çœ‹ ${rec.wrongs.length} é¡ŒéŒ¯é¡Œ</summary>`;
                    rec.wrongs.forEach(w => {
                        wrongsHtml += `<div style="font-size:0.85rem; padding:6px 0; border-bottom:1px dashed #eee;">
                            <strong style="color:#555;">${w.q}</strong><br>
                            <span style="color:#ff7675; text-decoration:line-through;">${w.user}</span> 
                            <span style="color:#00b894;">${w.right}</span>
                        </div>`;
                    });
                    wrongsHtml += `</details>`;
                } else {
                    wrongsHtml = `<div style="color:#00b894; font-size:0.85rem; margin-top:5px; font-weight:bold;">âœ¨ Perfect!</div>`;
                }

                html += `
                <div class="history-card">
                    <div class="h-top">
                        <span class="h-date">${rec.date}</span>
                        <span class="diff-badge ${dClass}" style="margin:0; font-size:0.7rem; box-shadow:none; padding:3px 10px;">${dLabel}</span>
                    </div>
                    <div class="h-score">${rec.score} åˆ†</div>
                    ${wrongsHtml}
                </div>`;
            });
            container.innerHTML = html;
        }
        showScreen('history-screen');
    }

</script>

</body>
</html>